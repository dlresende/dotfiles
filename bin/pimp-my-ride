#!/usr/bin/env bash

[[ -z "$DEBUG" ]] || set -x

set -e # bail out early if any command fails
set -u # fail if we hit unset variables
set -o pipefail # fail if any component of any pipe fails

# shellcheck disable=SC1090
lpass show --notes dotfilesrc > ~/.dotfilesrc && source ~/.dotfilesrc

# https://github.com/Homebrew/homebrew-cask/issues/42142
export HOMEBREW_NO_ENV_FILTERING=1

main() {
  configure_ruby
  install_stuff
  configure_vim
  configure_tmux
  install_oh_my_zsh
  configure_go_workspace
  configure_git
}

configure_ruby() {
  rbenv install -s "$(cat ~/.rbenv/version)"
}

update_homebrew() {
  brew -h > /dev/null 2>&1 && brew update
}

install_homebrew() {
  brew -h > /dev/null 2>&1 || /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
}

install_stuff() {
  update_homebrew || install_homebrew

  brew bundle --global
}

checkout_projects() {
  mkdir -p "$HOME/Projects"

  ( cd "$HOME" || exit 1
    mr update
  )
}

configure_vim() {
  if [[ ! -d "$HOME/.vim" ]] ; then
    git clone https://github.com/dlresende/vimfiles.git ~/.vim
  fi

  ( cd "$HOME/.vim" || exit 1
    git pull
    make install
  )
}

configure_tmux() {
  TMUX_PLUGIN_MANAGER_PATH="$HOME/.tmux/plugins"

  echo "Updating tmux plugins..."
  if [[ ! -d "$TMUX_PLUGIN_MANAGER_PATH/tpm" ]] ; then
    mkdir -p "$TMUX_PLUGIN_MANAGER_PATH"
    git clone https://github.com/tmux-plugins/tpm "$TMUX_PLUGIN_MANAGER_PATH/tpm"
    "$TMUX_PLUGIN_MANAGER_PATH"/tpm/bin/install_plugins
  else
    ( cd "$TMUX_PLUGIN_MANAGER_PATH/tpm" && git pull )
    "$TMUX_PLUGIN_MANAGER_PATH"/tpm/bin/update_plugins all
  fi
}

install_oh_my_zsh() {
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
}

configure_go_workspace() {
  if [[ -L "$HOME"/go/src && -d "$HOME"/go/src ]]
  then
    echo "Go workspace already configured. Moving on."
  fi

  mv "$HOME"/go/src/* "$HOME"/Projects
  rm -fr "$HOME"/go/src
  ln -s "$HOME"/Projects "$HOME"/go/src
}

configure_git() {
  git config --global core.excludesfile ~/.gitignore_global
  git config --global pull.rebase false
}

main
