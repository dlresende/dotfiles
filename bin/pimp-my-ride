#!/usr/bin/env bash

main() {
  install_homebrew
  install_stuff
  configure_homebrew_to_work_with_multiple_accounts
  configure_vim
  configure_tmux
  install_oh_my_zsh
}

install_homebrew() {
  brew -h > /dev/null 2>&1 || /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
}

install_stuff() {
  brew bundle --global
}

configure_vim() {
  if [[ ! -d "$HOME/.vim" ]] ; then
    git clone https://github.com/luan/vimfiles.git ~/.vim
  fi
  (
  cd "$HOME/.vim" || exit 1
  git checkout master
  git pull -r
  ./update
  )

  pip3 install --user --upgrade neovim # Required by some plugins like deoplate
}

configure_tmux() {
  TMUX_PLUGIN_MANAGER_PATH="$HOME/.tmux/plugins"

  echo "Updating tmux plugins..."
  if [[ ! -d "$TMUX_PLUGIN_MANAGER_PATH/tpm" ]] ; then
    mkdir -p "$TMUX_PLUGIN_MANAGER_PATH"
    git clone https://github.com/tmux-plugins/tpm "$TMUX_PLUGIN_MANAGER_PATH/tpm"
    "$TMUX_PLUGIN_MANAGER_PATH"/tpm/bin/install_plugins
  else
    (cd "$TMUX_PLUGIN_MANAGER_PATH/tpm" && git pull )
    "$TMUX_PLUGIN_MANAGER_PATH"/tpm/bin/update_plugins all
  fi
}

configure_homebrew_to_work_with_multiple_accounts() {
  echo "Updating file permissions to allow Homebrew being used with accounts..."

  local usr_local_permissions_backup_file
  usr_local_permissions_backup_file="$(gmktemp -t usr_local_permissions_backup_file.XXXXXX.txt)"
  ls -lhR /usr/local > "$usr_local_permissions_backup_file"

  # Some tools (like ruby-install) base themselves on the user having installed Homebrew
  # in order to install and configure stuff (by doing: `/usr/bin/stat -f %Su /usr/local/bin/brew`)
  sudo chown -h "$(whoami)" /usr/local/bin/brew

  sudo chgrp -R admin /usr/local/{Cellar,Homebrew}
  sudo chmod -R g+w /usr/local/{Cellar,Homebrew,lib}

  # Workaround to avoid Permission Denied issues with `brew link`
  # More details: http://stackoverflow.com/questions/8175697/rm-cannot-remove-permission-denied
  sudo chmod -R g+w /usr/local/lib
}

install_oh_my_zsh() {
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
}

main
